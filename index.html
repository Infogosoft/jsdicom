<html>

<head>
    <title>DICOM</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script type="text/javascript" src="js/jquery-1.7.min.js"></script>
    <script type="text/javascript" src="js/app.js"></script>
    <script type="text/javascript" src="js/binutils.js"></script>
    <script type="text/javascript" src="js/dcmfile.js"></script>
    <script type="text/javascript" src="js/dicomparser.js"></script>
    <script type="text/javascript">

    var ww = 100.0;
    var wl = 1000.0;

    function file_loaded(app) {
        console.log("image size: (" + app.width + ", " + app.height + ")");
        redraw_image();
    }
    var app = new DcmApp('c1');
    function init() {
        app.init();
    }

    function redraw_image() {
        if (app.pixel_data == undefined)
            return;
        var element = document.getElementById('c1');
        var c = element.getContext("2d");
        var imageData = c.createImageData(app.width, app.height);
        for(var x=0;x<app.width;++x) {
            for(var y=0;y<app.height;++y) {
                data_idx = (x + y*app.width)*2;
                var intensity = app.pixel_data[data_idx+1]*256.0 + app.pixel_data[data_idx];
                var lower_bound = wl - ww;
                var upper_bound = wl + ww;
                var intensity = (intensity - lower_bound)/upper_bound;
                if(intensity < 0)
                    intensity = 0x00;
                if(intensity > 100)
                    intensity = 0xFF;
                intensity *= 255;

                // intensity = intensity/0xFF;
                var canvas_idx = (x + y*app.width)*4;
                imageData.data[canvas_idx] = intensity;
                imageData.data[canvas_idx+1] = intensity;
                imageData.data[canvas_idx+2] = intensity;
                imageData.data[canvas_idx+3] = 0xFF;
            }
        }
        c.putImageData(imageData, 0, 0);
        c.strokeStyle = 'white';
        c.strokeText("WL: " + wl, 5, 20);
        c.strokeText("WW: " + ww, 5, 40);

    }

    $(document).ready(function() {
        $("input[type=file]").change(function(evt) {
            app.load_file(evt);
        });
        $("#ww").change(function() {
            ww = parseFloat($(this).val());
            //redraw_image();
        });
        $("#wl").change(function() {
            wl = parseFloat($(this).val());
            //redraw_image();
        });
        $("canvas").mousemove(function(e) {
            wl = e.clientX*2;
            ww = e.clientY*4;
            //redraw_image();
        });
    });

    </script>
</head>
<body onload="init();">
    <div id="canvas-holder">
        <canvas id="c1" width="512" height="512"></canvas>
    </div>
    <div id="right-sidebar">
        <form name="selectfile">
            <label for="file">File</label>
            <input type="file" name="file" id="file"/>
        </form>
        <div id="info" ></div>
        <ul id="loglist">
        </ul>
    </div>
</body>
</html>
